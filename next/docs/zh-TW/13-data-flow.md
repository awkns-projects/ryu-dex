# 資料流與關聯

## 概覽

理解資料如何在平台中流動對於建立有效的自動化工作流程至關重要。本指南解釋輸入/輸出模式、欄位關聯以及資料如何在模型、動作和外部服務之間移動。

## 資料流基礎

### 基本流程

```
輸入 → 處理 → 輸出

範例：
  使用者輸入（表單）→ AI 生成（動作）→ 儲存結果（欄位）
```

### 平台資料流

```
┌─────────────┐
│ 資料來源     │
│  - 表單     │
│  - API      │
│  - 手動     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   欄位      │ ◄──┐
│  （儲存）   │    │
└──────┬──────┘    │
       │           │
       ▼           │
┌─────────────┐    │
│   動作      │    │
│ （處理）    │    │
└──────┬──────┘    │
       │           │
       ▼           │
┌─────────────┐    │
│  輸出       │────┘
│  - 欄位     │
│  - API      │
│  - 記錄     │
└─────────────┘
```

## 欄位層級資料流

### 輸入欄位

從外部來源接收資料的欄位：

```
表單提交：
  使用者填寫表單 →
  firstName: "John" →
  lastName: "Doe" →
  email: "john@example.com" →
  儲存在客戶記錄中

API 匯入：
  外部 API →
  productData: {...} →
  解析和映射 →
  儲存在產品欄位中

手動輸入：
  使用者在表單中輸入 →
  title: "新文章" →
  儲存到文章記錄
```

### 處理欄位

在動作執行期間使用的欄位：

```
動作：生成社交貼文

讀取：
  - 文章.title（輸入）
  - 文章.content（輸入）
  - 設定.platform（輸入）

處理：
  AI 使用輸入生成說明

寫入：
  - 社交貼文.caption（輸出）
  - 社交貼文.generatedAt（元資料）
```

### 輸出欄位

儲存處理結果的欄位：

```
動作執行後：

原始狀態：
  文章.title: "10 個 AI 技巧"
  文章.content: "Lorem ipsum..."
  社交貼文.caption: null

處理後：
  文章.title: "10 個 AI 技巧"（未變更）
  文章.content: "Lorem ipsum..."（未變更）
  社交貼文.caption: "🤖 發現 10 個改變遊戲規則的 AI 技巧..."（生成）
```

## 模型層級資料流

### 父子流程

```
父模型：部落格文章
  id: 1
  title: "如何使用 AI"
  content: "..."
  status: "已發布"

動作：「分發到社交」
  讀取父文章
  生成社交內容
  建立子項

建立的子記錄：
  
  社交貼文 1（Instagram）：
    sourceArticle: 1
    platform: "Instagram"
    caption: "🤖 學習如何..."
    
  社交貼文 2（Twitter）：
    sourceArticle: 1
    platform: "Twitter"
    caption: "您需要的 AI 技巧..."
    
  社交貼文 3（LinkedIn）：
    sourceArticle: 1
    platform: "LinkedIn"
    caption: "專業 AI 指南..."

資料從父流向子
```

### 同級資料流

```
模型 A：潛在客戶提交
  id: 101
  email: "prospect@example.com"
  interest: "企業方案"

動作：「處理潛在客戶」
  
  在模型 B（客戶）中建立：
    email: "prospect@example.com"
    source: "網站表單"
    status: "新"
  
  在模型 C（任務）中建立：
    title: "跟進潛在客戶"
    assignee: "銷售團隊"
    dueDate: 明天

一個輸入建立多個相關記錄
```

## 動作資料流

### 單一動作流程

```
動作：「生成產品描述」

┌─────────────────────────┐
│ 輸入欄位                │
│  - 產品.name            │
│  - 產品.features        │
│  - 產品.category        │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 步驟 1：AI 推理         │
│  生成描述               │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 步驟 2：AI 推理         │
│  生成 SEO 關鍵字        │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 輸出欄位                │
│  - 產品.description     │
│  - 產品.seo_keywords    │
└─────────────────────────┘
```

### 具有相依性的多步驟流程

```
動作：「完整內容管道」

步驟 1：提取重點
  輸入：文章.content
  輸出：Temp.keyPoints

步驟 2：生成社交說明
  輸入：文章.title + Temp.keyPoints
  輸出：社交貼文.caption

步驟 3：生成圖像提示
  輸入：文章.title + Temp.keyPoints
  輸出：Temp.imagePrompt

步驟 4：生成圖像
  輸入：Temp.imagePrompt
  輸出：社交貼文.imageUrl

步驟 5：發布到 Instagram
  輸入：社交貼文.caption + 社交貼文.imageUrl
  輸出：社交貼文.externalId

步驟 6：更新狀態
  輸入：社交貼文.externalId
  輸出：社交貼文.status = "已發布"

資料依序流經步驟
```

## 工作區層級資料流

### 全域欄位存取

```
工作區：內容中心

模型 A：部落格文章
  - title
  - content
  - author

模型 B：電子報
  - edition
  - featured_articles

模型 C：社交貼文
  - platform
  - caption

模型 C 中的動作可以存取：
  ✓ 社交貼文.platform（本地）
  ✓ 文章.title（全域，工作區）
  ✓ 文章.content（全域，工作區）
  ✓ 電子報.edition（全域，工作區）

所有工作區欄位都可用
```

### 跨模型更新

```
動作：「發布文章」
位置：部落格文章模型

步驟 1：更新當前文章
  文章.status = "已發布"
  文章.publishedAt = 現在

步驟 2：建立社交貼文（模型 B）
  對每個平台：
    建立帶有 sourceArticle 的社交貼文

步驟 3：更新電子報（模型 C）
  電子報.latestArticle = 當前文章
  電子報.articleCount += 1

一個動作更新多個模型
```

## 外部資料流

### 傳入資料（API → 平台）

```
外部 API → Webhook → 平台

範例：Shopify 訂單

1. 客戶在 Shopify 下訂單
2. Shopify 傳送 webhook
3. 平台接收 webhook
4. 解析訂單資料
5. 在訂單模型中建立記錄：
   - orderId：外部 ID
   - customerEmail：來自有效負載
   - total：來自有效負載
6. 觸發動作「處理新訂單」
7. 動作建立運送任務
8. 動作傳送確認電子郵件

外部資料觸發內部工作流程
```

### 傳出資料（平台 → API）

```
平台 → API 呼叫 → 外部服務

範例：發布到 Instagram

1. 使用者在平台中建立社交貼文
2. 填寫說明和圖像
3. 動作「發布到 Instagram」執行
4. 步驟 1：上傳圖像到 Instagram
   - API：POST /media
   - 主體：{image_url, caption}
   - 回應：{media_id}
5. 步驟 2：發布媒體
   - API：POST /media_publish
   - 主體：{creation_id: media_id}
   - 回應：{id, permalink}
6. 儲存回應資料：
   - 社交貼文.externalId = id
   - 社交貼文.url = permalink
   - 社交貼文.status = "已發布"

內部資料推送到外部服務
```

### 雙向同步

```
平台 ↔ 外部服務

範例：Google Sheets 同步

1. 使用者在平台中更新記錄
   欄位：產品.price = $99.99

2. 更新時觸發動作
   「同步到 Google Sheets」

3. 動作更新 Google Sheet：
   API：PUT spreadsheet/values
   儲存格：B5 = 99.99

4. Google Sheet 公式計算稅
   儲存格：C5 = B5 * 1.08 = 107.99

5. 排程每小時獲取資料
   API：GET spreadsheet/values
   讀取：C5 = 107.99

6. 更新平台：
   產品.priceWithTax = $107.99

持續雙向同步
```

## 資料轉換流程

### 簡單轉換

```
輸入 → 轉換 → 輸出

範例：姓名格式化

輸入：
  firstName: "john"
  lastName: "DOE"

轉換（動作）：
  首字母大寫每個單字

輸出：
  firstName: "John"
  lastName: "Doe"
```

### 複雜轉換

```
多個輸入 → AI 處理 → 結構化輸出

輸入：
  產品.rawData: "筆記型電腦，16GB RAM，512GB SSD，Intel i7"

動作：「解析產品規格」
  AI 提取結構化資料

輸出：
  產品.type: "筆記型電腦"
  產品.ram: "16GB"
  產品.storage: "512GB"
  產品.processor: "Intel i7"

非結構化 → 結構化
```

## 可重用性模式

### 重用生成的內容

```
步驟 1：生成內容一次
  輸入：文章.title，文章.content
  AI 生成：摘要
  輸出：文章.summary

步驟 2：在多個地方使用
  - 電子郵件主旨（來自文章.summary）
  - 社交說明（來自文章.summary）
  - 元描述（來自文章.summary）
  - 電子報簡介（來自文章.summary）

生成一次，多次使用
```

## 效能與優化

### 批次處理流程

```
低效：
  對 100 個產品中的每一個：
    - 從 API 獲取類別
    - 處理產品
    - 更新產品
  
  結果：100 次 API 呼叫

高效：
  - 一次獲取所有類別（1 次 API 呼叫）
  - 對 100 個產品中的每一個：
      - 從快取查詢類別
      - 處理產品
      - 排隊更新
  - 批次更新所有產品
  
  結果：2 次 API 呼叫
```

### 快取流程

```
第一次請求：
  使用者請求：產品詳情
  檢查快取：未找到
  從 API 獲取：產品資料
  儲存在快取中：5 分鐘 TTL
  返回：產品資料
  
後續請求（在 5 分鐘內）：
  使用者請求：產品詳情
  檢查快取：找到
  返回：快取的資料（無 API 呼叫）

5 分鐘後：
  快取過期
  下次請求獲取新資料
  
減少 API 呼叫，提高速度
```

## 資料完整性

### 驗證流程

```
輸入驗證：
  表單提交：
    email: "notanemail"
  
  驗證：
    ✗ 無效的電子郵件格式
    錯誤：「請輸入有效的電子郵件」
    阻止提交

處理驗證：
  在 API 呼叫之前：
    imageUrl：欄位為空
  
  驗證：
    ✗ 缺少必填欄位
    跳過 API 步驟
    記錄錯誤

輸出驗證：
  在 AI 生成之後：
    caption：350 個字元
    
  驗證：
    ✗ 超出平台限制（280）
    截斷或重新生成
    記錄警告

在每個階段驗證
```

## 監控資料流

### 流程追蹤

```
追蹤 ID：trace_abc123

1. 表單提交（09:00:00）
   建立記錄：客戶 #456
   欄位：name, email, company

2. 觸發動作（09:00:01）
   動作：「處理新客戶」
   輸入：客戶 #456

3. 執行步驟 1（09:00:02）
   AI 推理：生成歡迎電子郵件
   輸出：填充的電子郵件模板

4. 執行步驟 2（09:00:05）
   API 呼叫：透過 SendGrid 傳送電子郵件
   回應：訊息 ID msg_xyz789

5. 執行步驟 3（09:00:06）
   更新：客戶.welcomeEmailSent = true

6. 完成（09:00:06）
   持續時間：6 秒
   狀態：成功

追蹤整個流程中的資料
```

## 最佳實踐

### 設計原則

**單一事實來源**
```
好：
  產品.name 儲存一次
  其他模型透過關聯參照

避免：
  在多個模型中複製產品.name
```

**清晰的資料方向**
```
好：
  表單 → 欄位 → 動作 → 輸出 → API
  清晰的流程，易於追蹤

避免：
  循環相依性
  不清楚的資料來源
```

**最小化轉換**
```
好：
  以可用格式儲存資料
  僅在必要時轉換

避免：
  重複轉換
  有損轉換
```

## 下一步

- [動作](./09-actions.md) - 建立資料處理工作流程
- [動作步驟](./10-action-steps.md) - 配置流程步驟
- [模型與表單](./06-models-and-sheets.md) - 建構您的資料
- [最佳實踐](./14-best-practices.md) - 優化技術
