services:
  # PostgreSQL Database for Next.js App
  postgres:
    image: postgres:15-alpine
    container_name: ryu-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-ryu_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ryu_password}
      POSTGRES_DB: ${POSTGRES_DB:-ryu_db}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - ryu-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ryu_user} -d ${POSTGRES_DB:-ryu_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Go Backend Service (NOFX Trading System) - Development Mode
  nofx-backend:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.backend.dev
    container_name: ryu-backend
    restart: unless-stopped
    stop_grace_period: 30s
    ports:
      - "${NOFX_BACKEND_PORT:-8080}:8080"
    volumes:
      # Mount source code for development (hot reload)
      # Mount entire project root - Go will only compile what's needed
      - .:/app
      # Use anonymous volumes to exclude large directories (faster performance)
      - /app/node_modules
      - /app/next/node_modules
      - /app/web/node_modules
      - /app/next/.next
      - /app/web/dist
      # Use named volume for database directory to avoid permission issues with SQLite
      - backend_db:/app/data
      # Mount secrets separately to ensure proper permissions
      - ./secrets:/app/secrets:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TZ=${NOFX_TIMEZONE:-UTC}
      - AI_MAX_TOKENS=${AI_MAX_TOKENS:-4000}
      - DATA_ENCRYPTION_KEY=${DATA_ENCRYPTION_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - NOFX_BACKEND_PORT=${NOFX_BACKEND_PORT:-8080}
    networks:
      - ryu-network
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # pgAdmin - PostgreSQL Database Management Tool
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: ryu-pgadmin
    restart: unless-stopped
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL:-admin@ryu.local}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD:-admin}
      - PGADMIN_CONFIG_SERVER_MODE=False
      - PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED=False
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - ryu-network
    depends_on:
      postgres:
        condition: service_healthy

  # SQLite Web Viewer - SQLite Database Management Tool
  sqlite-web:
    image: coleifer/sqlite-web:latest
    container_name: ryu-sqlite-web
    restart: unless-stopped
    ports:
      - "${SQLITE_WEB_PORT:-8081}:8080"
    volumes:
      # Mount the backend database volume
      - backend_db:/data:ro
    command: ["sqlite_web", "/data/config.db"]
    networks:
      - ryu-network
    depends_on:
      nofx-backend:
        condition: service_healthy

  # Next.js Frontend Service (Development Mode)
  ryu-next:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.next.dev
    container_name: ryu-next
    restart: unless-stopped
    ports:
      - "${RYU_NEXT_PORT:-3000}:3000"
    environment:
      # Database Configuration
      - DATABASE_URL=postgresql://${POSTGRES_USER:-ryu_user}:${POSTGRES_PASSWORD:-ryu_password}@postgres:5432/${POSTGRES_DB:-ryu_db}?schema=public
      - POSTGRES_URL=postgresql://${POSTGRES_USER:-ryu_user}:${POSTGRES_PASSWORD:-ryu_password}@postgres:5432/${POSTGRES_DB:-ryu_db}?schema=public
      # SQLite Database Path (for accessing Go backend's config.db)
      - SQLITE_DB_PATH=/data/config.db
      
      # Go Backend API Configuration
      - GO_API_URL=http://nofx-backend:8080
      - NEXT_PUBLIC_API_URL=http://localhost:8080
      
      # App Configuration
      - NODE_ENV=${NODE_ENV:-development}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      
      # Optional: Thirdweb/NFT Configuration
      - NEXT_PUBLIC_THIRDWEB_CLIENT_ID=${NEXT_PUBLIC_THIRDWEB_CLIENT_ID:-}
      - NEXT_PUBLIC_NETWORK=${NEXT_PUBLIC_NETWORK:-testnet}
      
      # Optional: Stripe Configuration (for subscriptions)
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY:-}
      
      # Optional: Email Configuration (Resend)
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL:-ryu@example.com}
      
      # Optional: Vercel Configuration (for deployment features)
      - VERCEL_TOKEN=${VERCEL_TOKEN:-}
      - VERCEL_TEAM_ID=${VERCEL_TEAM_ID:-}
      
    volumes:
      # Mount source code for development (hot reload)
      - ./next:/app
      - /app/node_modules
      - /app/.next
      # Mount project root so ../config.db from /app resolves correctly
      # This allows Next.js to access the Go backend's config.db
      - .:/workspace:ro
      # Also mount the database volume and create symlink via entrypoint
      - backend_db:/data:ro
    networks:
      - ryu-network
    depends_on:
      postgres:
        condition: service_healthy
      nofx-backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  postgres_data:
    driver: local
  backend_db:
    driver: local
  pgadmin_data:
    driver: local

networks:
  ryu-network:
    driver: bridge

